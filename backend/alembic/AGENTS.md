# Alembic Database Migrations

## Overview

The `backend/alembic/` directory contains database migration scripts managed by Alembic. All database schema changes MUST go through Alembic migrations - never use `create_all()`, `--reset-db`, or manual SQL.

## Directory Structure

```
alembic/
├── env.py                # Alembic environment configuration
├── script.py.mako        # Migration template
├── alembic.ini           # Alembic config (in backend/)
└── versions/             # Migration files
    ├── 001_initial_schema.py
    ├── 002_add_players_table.py
    └── ...
```

## Key Commands

**Always use the helper script** `./scripts/alembic.sh` instead of direct alembic commands:

```bash
# Check current migration status
./scripts/alembic.sh current

# View migration history
./scripts/alembic.sh history

# Create new migration after changing models
./scripts/alembic.sh revision --autogenerate -m "Add smurf_scores table"

# Apply all pending migrations
./scripts/alembic.sh upgrade head

# Rollback one migration
./scripts/alembic.sh downgrade -1

# Rollback to specific version
./scripts/alembic.sh downgrade <revision_id>
```

## Migration Workflow

### 1. Modify SQLAlchemy Models

Edit your feature's `models.py`:

```python
# backend/app/features/smurf_detection/models.py
from app.core.models import BaseModel
from sqlalchemy import Column, Integer, String, Float

class SmurfScore(BaseModel):
    """Smurf detection score model."""

    __tablename__ = "smurf_scores"

    player_id = Column(Integer, ForeignKey("players.id"), nullable=False)
    confidence = Column(Float, nullable=False)
    factors = Column(String, nullable=False)  # JSON string
```

### 2. Generate Migration

Alembic detects model changes and generates migration:

```bash
./scripts/alembic.sh revision --autogenerate -m "Add smurf_scores table"
```

**Output:**
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'smurf_scores'
  Generating /app/alembic/versions/abc123_add_smurf_scores_table.py ...  done
```

### 3. Review Generated Migration

**Always review autogenerated migrations** before applying:

```python
# alembic/versions/abc123_add_smurf_scores_table.py
def upgrade():
    # ### commands auto generated by Alembic ###
    op.create_table('smurf_scores',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('player_id', sa.Integer(), nullable=False),
    sa.Column('confidence', sa.Float(), nullable=False),
    sa.Column('factors', sa.String(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['player_id'], ['players.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic ###
    op.drop_table('smurf_scores')
    # ### end Alembic commands ###
```

**Review checklist:**
- ✅ Table name matches model's `__tablename__`
- ✅ Columns match model attributes
- ✅ Foreign keys are correct
- ✅ Indexes are defined if needed
- ✅ `downgrade()` properly reverses changes
- ✅ No external library tables (e.g., APScheduler manages its own schema)

### 4. Apply Migration

```bash
./scripts/alembic.sh upgrade head
```

**Output:**
```
INFO  [alembic.runtime.migration] Running upgrade def456 -> abc123, Add smurf_scores table
```

### 5. Verify Migration

```bash
# Check current migration version
./scripts/alembic.sh current

# Verify in database
docker compose exec postgres psql -U riot_api_user -d riot_api_db -c "\dt"
```

## Common Migration Patterns

### Adding a Column

```python
def upgrade():
    op.add_column('players', sa.Column('region', sa.String(), nullable=True))

def downgrade():
    op.drop_column('players', 'region')
```

### Adding an Index

```python
def upgrade():
    op.create_index('idx_players_puuid', 'players', ['puuid'], unique=True)

def downgrade():
    op.drop_index('idx_players_puuid', table_name='players')
```

### Renaming a Column

```python
def upgrade():
    op.alter_column('players', 'name', new_column_name='game_name')

def downgrade():
    op.alter_column('players', 'game_name', new_column_name='name')
```

### Data Migration

For migrations that transform data (not just schema):

```python
from alembic import op
import sqlalchemy as sa

def upgrade():
    # Create new column
    op.add_column('players', sa.Column('full_name', sa.String(), nullable=True))

    # Migrate data
    conn = op.get_bind()
    conn.execute(
        sa.text("UPDATE players SET full_name = game_name || '#' || tag_line")
    )

    # Make column non-nullable after populating
    op.alter_column('players', 'full_name', nullable=False)

def downgrade():
    op.drop_column('players', 'full_name')
```

## Automatic Migration on Startup

The backend entrypoint automatically runs `alembic upgrade head` on startup, so migrations are applied when containers start:

```python
# backend/entrypoint.sh
alembic upgrade head
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

This means:
- **Development**: Migrations run when you start `./scripts/dev.sh`
- **Production**: Migrations run when deploying with `./scripts/prod.sh`

## Migration History

View migration history with:

```bash
./scripts/alembic.sh history --verbose
```

Example output:
```
abc123 -> head, Add smurf_scores table (2025-10-22)
def456 -> abc123, Add matches table (2025-10-21)
<base> -> def456, Initial schema (2025-10-20)
```

## Rollback Strategy

### Development Rollback

```bash
# Rollback one migration
./scripts/alembic.sh downgrade -1

# Rollback to specific version
./scripts/alembic.sh downgrade def456
```

### Production Rollback

**Be cautious in production:**
1. **Backup database first**:
   ```bash
   docker compose exec postgres pg_dump -U riot_api_user -d riot_api_db > backup_before_rollback.sql
   ```

2. **Test rollback in staging environment**

3. **Roll back migration**:
   ```bash
   ./scripts/alembic.sh downgrade -1
   ```

4. **Verify application still works**

## Constraints and Rules

### ✅ Always Do

- Use `./scripts/alembic.sh` for all migration commands
- Review autogenerated migrations before applying
- Test migrations in development first
- Write meaningful migration messages
- Include `downgrade()` implementation
- Backup production database before migrations

### ❌ Never Do

- Use `Base.metadata.create_all()` (bypasses migrations)
- Use `--reset-db` flags in production
- Manually edit applied migration files
- Run raw SQL without migrations
- Manage external library tables (e.g., APScheduler)
- Skip migration review
- Delete migration files (use downgrade instead)

## Troubleshooting

### Migration Out of Sync

If Alembic reports mismatch between database and models:

```bash
# Check current state
./scripts/alembic.sh current

# View pending migrations
./scripts/alembic.sh history

# Force stamp to specific version (use with caution)
./scripts/alembic.sh stamp head
```

### Autogenerate Misses Changes

Sometimes autogenerate doesn't detect all changes. Manually edit the migration:

```python
def upgrade():
    # Auto-detected changes
    op.add_column('players', sa.Column('level', sa.Integer(), nullable=True))

    # Manually added
    op.create_index('idx_players_level', 'players', ['level'])
```

### Conflicting Migrations

If multiple branches create migrations:

```bash
# List all head revisions
./scripts/alembic.sh heads

# Merge heads
./scripts/alembic.sh merge <head1> <head2> -m "Merge migration heads"
```

## See Also

- `backend/app/core/AGENTS.md` - Database and models
- `backend/app/features/AGENTS.md` - Feature development (includes models)
- `scripts/AGENTS.md` - Helper script usage
