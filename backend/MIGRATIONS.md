# Database Migrations with Alembic

This project uses **Alembic** for database schema management and migrations. All schema changes are version-controlled and can be applied incrementally.

## Quick Reference

```bash
# Create a new migration after changing models
docker compose exec backend uv run alembic revision --autogenerate -m "description"

# Apply pending migrations
docker compose exec backend uv run alembic upgrade head

# View current migration version
docker compose exec backend uv run alembic current

# View migration history
docker compose exec backend uv run alembic history

# Downgrade one migration
docker compose exec backend uv run alembic downgrade -1

# Downgrade to specific revision
docker compose exec backend uv run alembic downgrade <revision>
```

## Workflow for Schema Changes

### 1. Modify SQLAlchemy Models

Edit model files in `backend/app/models/`:
- Add/remove/modify columns
- Add/remove tables
- Update indexes, constraints, etc.

### 2. Generate Migration

```bash
docker compose exec backend uv run alembic revision --autogenerate -m "Add user_email column"
```

This creates a new migration file in `backend/alembic/versions/`.

### 3. Review Generated Migration

**IMPORTANT**: Always review autogenerated migrations before applying!

Check the generated file in `backend/alembic/versions/<revision>_<description>.py`:
- Verify the `upgrade()` function contains expected changes
- Verify the `downgrade()` function properly reverts changes
- Remove any unintended operations (like dropping external tables)

### 4. Apply Migration

Development:
```bash
docker compose exec backend uv run alembic upgrade head
```

Production:
```bash
# Inside production container
uv run alembic upgrade head
```

### 5. Verify Migration

```bash
# Check current version
docker compose exec backend uv run alembic current

# Inspect database schema
docker compose exec postgres psql -U riot_api_user -d riot_api_db -c "\d table_name"
```

## Creating Manual Migrations

For complex changes that can't be autogenerated:

```bash
docker compose exec backend uv run alembic revision -m "custom migration description"
```

Edit the generated file and write custom `upgrade()` and `downgrade()` functions.

## Best Practices

### ✅ DO:
- **Review all autogenerated migrations** before applying
- **Test migrations on dev database** before production
- **Keep migrations small** and focused on one change
- **Write descriptive migration messages**
- **Commit migration files** to version control
- **Add data migrations** when renaming/restructuring columns

### ❌ DON'T:
- **Don't modify applied migrations** (create new ones instead)
- **Don't skip reviewing autogenerated code**
- **Don't apply untested migrations** to production
- **Don't use `create_all()` / `drop_all()`** (use migrations instead)
- **Don't manually edit the database** (use migrations)

## Configuration

### Database URL

Alembic reads the database URL from `backend/app/config.py` via environment variables:
- Automatically uses `postgresql+asyncpg://` for async support
- No hardcoded credentials in `alembic.ini`

### Naming Conventions

Constraint naming conventions are defined in `backend/app/models/__init__.py`:
- Indexes: `ix_<column_name>`
- Unique constraints: `uq_<table_name>_<column_name>`
- Check constraints: `ck_<table_name>_<constraint_name>`
- Foreign keys: `fk_<table_name>_<column_name>_<referred_table_name>`
- Primary keys: `pk_<table_name>`

## Migration History

To view all applied migrations:

```bash
docker compose exec backend uv run alembic history --verbose
```

To see pending migrations:

```bash
docker compose exec backend uv run alembic current
docker compose exec backend uv run alembic heads
```

## Rollback Strategy

### Development

```bash
# Rollback last migration
docker compose exec backend uv run alembic downgrade -1

# Rollback to specific revision
docker compose exec backend uv run alembic downgrade <revision>
```

### Production

1. **Backup database first**:
   ```bash
   docker compose exec postgres pg_dump -U riot_api_user -d riot_api_db > backup.sql
   ```

2. **Test rollback in staging**

3. **Apply rollback to production**:
   ```bash
   uv run alembic downgrade -1
   ```

4. **Verify application works**

## Troubleshooting

### "Target database is not up to date"

Your database doesn't have all migrations applied:
```bash
docker compose exec backend uv run alembic upgrade head
```

### "Can't locate revision identified by X"

Migration files are out of sync with database:
```bash
# View current database version
docker compose exec backend uv run alembic current

# Check if migration file exists
ls backend/alembic/versions/
```

### "FAILED: Multiple head revisions are present"

Multiple migration branches exist. Merge them:
```bash
docker compose exec backend uv run alembic merge heads -m "merge branches"
```


## Comparison with Old System

| Feature | Old System (SQL) | New System (Alembic) |
|---------|------------------|----------------------|
| Version tracking | ❌ None | ✅ alembic_version table |
| Auto-detection | ❌ Manual | ✅ Autogenerate from models |
| Rollback | ❌ Not supported | ✅ Full downgrade support |
| Dev/Prod parity | ❌ Manual sync | ✅ Automatic via migrations |
| Schema drift | ❌ Common | ✅ Prevented |
| Data preservation | ❌ create_all() destroys data | ✅ Incremental changes |

## Further Reading

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 2.0 Documentation](https://docs.sqlalchemy.org/)
- [FastAPI with Alembic Tutorial](https://testdriven.io/blog/fastapi-sqlmodel/)
