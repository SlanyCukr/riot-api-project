# Production Server: Raspberry Pi 5 16GB

## Server Access

- **Host**: `89.221.212.146`
- **Port**: `2221`
- **User**: `pi`
- **SSH Key**: `~/.ssh/raspberry_pi_key`

### Connect to Server

```bash
ssh -i ~/.ssh/raspberry_pi_key -l pi 89.221.212.146 -p 2221
```

Or add to `~/.ssh/config`:

```
Host riot-prod
    HostName 89.221.212.146
    Port 2221
    User pi
    IdentityFile ~/.ssh/raspberry_pi_key
```

Then connect with: `ssh riot-prod`

## Project Deployment

### Location & Structure

- **Project Directory**: `/home/pi/riot-api`
- **Compose Files**: `compose.yaml` + `compose.prod.yaml`
- **Environment File**: `/home/pi/riot-api/.env` (generated by GitHub Actions)
- **Domain**: `https://leagueanalysis.gg`

### Services

- **Backend API**: `http://localhost:8000` (direct port mapping)
- **Frontend**: `http://localhost:3000` (direct port mapping)
- **PostgreSQL**: `localhost:5432` (direct port mapping)

## Automated Deployment

### GitHub Actions Self-Hosted Runner

The server runs a self-hosted GitHub Actions runner that automatically deploys code when pushed to the `main` branch.

**Runner Details**:
- **Name**: `rpi5-16gb-riot-api`
- **Location**: `/home/pi/actions-runner`
- **Process**: Running as systemd user service
- **Status**: Check with `ps aux | grep Runner.Listener`

**Workflow**: `.github/workflows/deploy.yml`

**Deployment Process**:
1. Trigger on push to `main` branch (or manual workflow_dispatch)
2. Runner checks out code to: `/home/pi/actions-runner/_work/riot-api-project/riot-api-project`
3. Stops existing containers
4. Removes old `/home/pi/riot-api` directory (with sudo for Docker-owned files)
5. Copies fresh code to `/home/pi/riot-api`
6. Generates `.env` file from GitHub Secrets
7. Builds with Docker Bake (parallel backend + frontend builds)
8. Starts services: `docker compose -f compose.yaml -f compose.prod.yaml up -d`
9. Runs health checks (PostgreSQL, Backend API, Frontend)
10. Cleans up unused Docker images

### GitHub Secrets Required

The deployment workflow uses these secrets:
- `RIOT_API_KEY`: Riot Games API key
- `POSTGRES_PASSWORD`: Database password
- `JWT_SECRET_KEY`: JWT token signing secret (32+ characters required)

#### Generating Secure JWT Secret

The JWT secret must be at least 32 characters (256 bits) to meet RFC 7518 security requirements. Generate a cryptographically secure secret using Python:

```bash
python3 -c 'import secrets; print(secrets.token_hex(32))'
```

**Example output**: `a7f8d9e2b4c6f1a3d5e7c9b1f3a5d7e9c2b4f6a8d0e2c4f6a8b0d2e4f6a8b0c2`

Add this secret to GitHub repository settings:
1. Go to **Settings** → **Secrets and variables** → **Actions**
2. Click **New repository secret**
3. Name: `JWT_SECRET_KEY`
4. Value: (paste generated secret)

**Security Notes**:
- Never use default values like "dev_secret_key_please_change_in_production"
- Never commit secrets to git
- Rotate secrets every 3-6 months or after security incidents
- The application will fail to start in production if an insecure secret is detected

## Common Operations

### Check Service Status

```bash
ssh riot-prod
cd ~/riot-api

# Check containers
docker compose -f compose.yaml -f compose.prod.yaml ps

# Check health
curl http://localhost:8000/health
curl http://localhost:3000

# View logs
docker compose -f compose.yaml -f compose.prod.yaml logs -f backend
docker compose -f compose.yaml -f compose.prod.yaml logs -f frontend
docker compose -f compose.yaml -f compose.prod.yaml logs -f postgres
```

### Restart Services

```bash
ssh riot-prod
cd ~/riot-api

# Restart all services
docker compose -f compose.yaml -f compose.prod.yaml restart

# Restart specific service
docker compose -f compose.yaml -f compose.prod.yaml restart backend
```

### Manual Deployment

If you need to deploy without pushing to GitHub:

```bash
ssh riot-prod
cd ~/riot-api

# Pull latest code
git pull origin main

# Rebuild and restart
docker compose -f compose.yaml -f compose.prod.yaml up -d --build
```

### Database Operations

```bash
ssh riot-prod
cd ~/riot-api

# Run migrations
docker compose -f compose.yaml -f compose.prod.yaml exec backend uv run alembic upgrade head

# Check migration status
docker compose -f compose.yaml -f compose.prod.yaml exec backend uv run alembic current

# Connect to database
docker compose -f compose.yaml -f compose.prod.yaml exec postgres psql -U riot_api_user -d riot_api_db

# Backup database
docker compose -f compose.yaml -f compose.prod.yaml exec postgres pg_dump -U riot_api_user riot_api_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

### View GitHub Actions Runner Logs

```bash
ssh riot-prod

# Check runner status
ps aux | grep Runner.Listener

# View recent runner logs
ls -lt ~/actions-runner/_diag/ | head -5
tail -f ~/actions-runner/_diag/Worker_*.log
```

## Reverse Tunnel Configuration (autossh)

The production server uses autossh to create a reverse SSH tunnel to a VPS, making the services accessible via `https://leagueanalysis.gg`.

### Current Port Mappings

**After recent port simplification (commit 42c2ac4):**

- Backend: `8000` (local) → tunnel to VPS
- Frontend: `3000` (local) → tunnel to VPS
- PostgreSQL: `5432` (local, internal use only)

### Update autossh Configuration

SSH to the production server and update the autossh service configuration:

```bash
ssh riot-prod

# Find the autossh service/systemd unit
systemctl --user list-units | grep autossh
# OR check for cron/startup scripts
cat /etc/systemd/system/autossh-tunnel.service

# Update port mappings in the autossh command
# OLD: -R 8000:localhost:8086 -R 3000:localhost:8088
# NEW: -R 8000:localhost:8000 -R 3000:localhost:3000

# Example systemd service edit
sudo systemctl edit --full autossh-tunnel.service

# Or if using systemd user service
systemctl --user edit --full autossh-tunnel.service

# Restart the tunnel
sudo systemctl restart autossh-tunnel.service
# OR
systemctl --user restart autossh-tunnel.service
```

### Verify Tunnel Status

```bash
# Check if autossh is running
ps aux | grep autossh

# Check tunnel connection
ssh riot-prod
ss -tlnp | grep -E ':8000|:3000'

# Test from VPS side (if you have access)
# curl http://localhost:8000/health
# curl http://localhost:3000
```

## Troubleshooting

### Service Won't Start

```bash
# Check container logs
docker compose -f compose.yaml -f compose.prod.yaml logs backend --tail=100

# Check if ports are in use
sudo netstat -tulpn | grep -E '8000|3000|5432'

# Restart with fresh containers
docker compose -f compose.yaml -f compose.prod.yaml down
docker compose -f compose.yaml -f compose.prod.yaml up -d
```

### Deployment Failed in GitHub Actions

1. Check the Actions tab in GitHub: https://github.com/SlanyCukr/riot-api-project/actions
2. SSH to the server and check runner logs:
   ```bash
   ssh riot-prod
   tail -100 ~/actions-runner/_diag/Worker_*.log
   ```
3. Check disk space:
   ```bash
   df -h
   ```
4. Check Docker status:
   ```bash
   docker system df
   docker ps -a
   ```

### Runner Not Responding

```bash
ssh riot-prod

# Check if runner is running
ps aux | grep Runner.Listener

# Restart runner service (if configured as systemd service)
systemctl --user status actions.runner.SlanyCukr-riot-api-project.rpi5-16gb-riot-api.service
systemctl --user restart actions.runner.SlanyCukr-riot-api-project.rpi5-16gb-riot-api.service

# Or manually
cd ~/actions-runner
./run.sh
```

### Database Issues

```bash
# Check PostgreSQL is running
docker compose -f compose.yaml -f compose.prod.yaml exec postgres pg_isready -U riot_api_user -d riot_api_db

# Check database size
docker compose -f compose.yaml -f compose.prod.yaml exec postgres psql -U riot_api_user -d riot_api_db -c "\l+"

# Check tables
docker compose -f compose.yaml -f compose.prod.yaml exec postgres psql -U riot_api_user -d riot_api_db -c "\dt"
```

## Server Resources

- **Model**: Raspberry Pi 5
- **RAM**: 16GB
- **Storage**: 2TB SSD
- **OS**: Raspberry Pi OS (64-bit Linux)

### Monitor Resources

```bash
ssh riot-prod

# Memory usage
free -h

# Disk usage
df -h

# CPU and uptime
uptime

# Docker resource usage
docker stats --no-stream
```

## Security Notes

- SSH uses key-based authentication (password auth disabled)
- Firewall configured for ports: 22 (SSH), 2221 (custom SSH), 8000 (backend), 3000 (frontend)
- GitHub Actions runner runs as non-root user `pi`
- Secrets managed via GitHub Secrets (not committed to repo)
- Reverse tunnel to VPS provides external HTTPS access

## Related Documentation

- [Deployment Guide](./deployment.md) - Detailed deployment procedures
- [Docker Documentation](../docker/AGENTS.md) - Docker Compose commands
- [Backend Documentation](../backend/AGENTS.md) - Backend API details
- [Alembic Migrations](../backend/alembic/AGENTS.md) - Database migrations
